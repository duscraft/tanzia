<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tanzia - Tableau de bord</title>
    <link rel="icon" href="/static/favicon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            colors: {
              background: "var(--background)",
              surface: "var(--surface)",
              surfaceHighlight: "var(--surface-highlight)",
              textMain: "var(--text-main)",
              textMuted: "var(--text-muted)",
              border: "var(--border)",
              primary: "var(--primary)",
              primaryHover: "var(--primary-hover)",
              primaryLight: "var(--primary-light)",
            },
          },
        },
      };
    </script>
    <style>
      :root {
        --background: #ffffff;
        --surface: #ffffff;
        --surface-highlight: #f3f4f6;
        --text-main: #111827;
        --text-muted: #6b7280;
        --border: #e5e7eb;
        --primary: #2563eb;
        --primary-hover: #1d4ed8;
        --primary-light: #eff6ff;
      }

      .dark {
        --background: #020617;
        --surface: #0f172a;
        --surface-highlight: #1e293b;
        --text-main: #f9fafb;
        --text-muted: #94a3b8;
        --border: #1e293b;
        --primary: #3b82f6;
        --primary-hover: #60a5fa;
        --primary-light: #1e293b;
      }

      body, .surface, .border-color, .text-color {
        transition-property: background-color, border-color, color, fill, stroke;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 200ms;
      }

      .glass {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(12px);
      }
      .dark .glass {
        background: rgba(15, 23, 42, 0.8);
      }
    </style>
    <script>
      if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    </script>
  </head>
  <body class="flex flex-col min-h-screen font-sans bg-background text-textMain antialiased selection:bg-primary selection:text-white">
    <nav class="w-full fixed top-0 z-40 border-b border-border glass transition-colors duration-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <div class="flex-shrink-0 flex items-center">
            <a href="/dashboard" class="flex items-center gap-2 group">
              <div class="w-8 h-8 rounded-lg bg-primary flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-primary/30 transition-transform group-hover:scale-105">T</div>
              <span class="text-xl font-bold tracking-tight text-textMain group-hover:text-primary transition-colors">Tanzia</span>
            </a>
          </div>

          <div class="flex items-center gap-4">
            <button id="theme-toggle" class="p-2 rounded-full text-textMuted hover:bg-surfaceHighlight hover:text-textMain transition-colors focus:outline-none focus:ring-2 focus:ring-primary/50" aria-label="Toggle theme">
              <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
              <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
            </button>
            
            <a href="/logout" class="text-sm font-medium text-textMuted hover:text-textMain transition-colors">Déconnexion</a>
            
            <a href="/persons" class="hidden sm:flex items-center gap-2 bg-primary hover:bg-primaryHover text-white text-sm font-medium px-4 py-2 rounded-lg shadow-md shadow-primary/20 transition-all hover:-translate-y-0.5">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
              Copropriétaire
            </a>
          </div>
        </div>
      </div>
    </nav>

    <div class="h-16"></div>

    <main class="max-w-7xl w-full mx-auto flex-grow px-4 sm:px-6 lg:px-8 py-12">
      {{if not .IsPremium}}
      <div class="mb-8 p-6 rounded-2xl bg-gradient-to-r from-primary/10 to-primaryHover/10 border border-primary/20">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
          <div>
            <h3 class="text-lg font-bold text-textMain mb-1">Passez à Tanzia Premium</h3>
            <p class="text-textMuted">Débloquez les copropriétaires, travaux et provisions illimités pour 9€/mois.</p>
          </div>
          <form action="/subscribe" method="POST">
            <button type="submit" class="flex items-center gap-2 bg-primary hover:bg-primaryHover text-white font-bold px-6 py-3 rounded-xl shadow-lg shadow-primary/20 transition-all hover:-translate-y-0.5 whitespace-nowrap">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
              Passer au Premium
            </button>
          </form>
        </div>
      </div>
      {{else}}
      <div class="mb-8 p-4 rounded-2xl bg-green-500/10 border border-green-500/20">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center">
              <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <div>
              <span class="font-bold text-green-700 dark:text-green-400">Tanzia Premium</span>
              <p class="text-sm text-textMuted">Vous bénéficiez d'un accès illimité.</p>
            </div>
          </div>
          <form action="/customer-portal" method="POST">
            <button type="submit" class="text-sm font-medium text-textMuted hover:text-textMain transition-colors underline underline-offset-2">
              Gérer mon abonnement
            </button>
          </form>
        </div>
      </div>
      {{end}}
      <div class="sm:hidden mb-8">
        <a href="/persons" class="flex w-full justify-center items-center gap-2 bg-primary hover:bg-primaryHover text-white font-bold py-3 rounded-xl shadow-lg transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
          Ajouter un copropriétaire
        </a>
      </div>

      <section class="mb-16">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
          <div>
            <h2 class="text-2xl font-bold text-textMain">Provisions de charges</h2>
            <p class="text-textMuted mt-1">Gérez les appels de fonds prévisionnels.</p>
          </div>
          <a href="/provisions" class="flex items-center gap-2 bg-surface hover:bg-surfaceHighlight text-textMain border border-border px-4 py-2 rounded-lg font-medium transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
            Nouvelle provision
          </a>
        </div>

        {{if or (eq (len .Provisions) 0) (eq (len .Persons) 0) }}
        <div class="p-12 rounded-2xl border-2 border-dashed border-border bg-surface/50 text-center">
          <div class="w-16 h-16 bg-surfaceHighlight rounded-full flex items-center justify-center mx-auto mb-4 text-textMuted">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
          </div>
          <h3 class="text-lg font-medium text-textMain mb-2">Aucune donnée</h3>
          <p class="text-textMuted max-w-md mx-auto">Commencez par ajouter des copropriétaires et créer une provision pour voir le tableau de répartition.</p>
        </div>
        {{else}}
        <div class="overflow-hidden rounded-2xl border border-border shadow-sm bg-surface">
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
              <thead class="text-xs text-textMuted uppercase bg-surfaceHighlight border-b border-border">
                <tr>
                  <th class="px-6 py-4 font-semibold">Libellé</th>
                  {{range $person := .Persons}}
                  <th class="px-6 py-4 font-semibold text-textMain">{{$person.Name}}</th>
                  {{end}}
                  <th class="px-6 py-4 font-semibold text-primary">Total</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                {{range $provision := .Provisions}}
                <tr class="hover:bg-surfaceHighlight/50 transition-colors">
                  <td class="px-6 py-4 font-medium text-textMain">{{$provision.Label}}</td>
                  {{range $person := $.Persons}}
                  <td class="px-6 py-4 text-textMuted">
                    {{printf "%.2f" ($person.CalculateProvision $.TotalTantiemes $provision)}} €
                  </td>
                  {{end}}
                  <td class="px-6 py-4 font-bold text-primary">
                    {{$provision.Amount}} €
                  </td>
                </tr>
                {{end}}
              </tbody>
            </table>
          </div>
        </div>
        {{end}}
      </section>

      <section>
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
          <div>
            <h2 class="text-2xl font-bold text-textMain">Travaux & Régularisation</h2>
            <p class="text-textMuted mt-1">Suivez les dépenses réelles et le solde.</p>
          </div>
          <a href="/bills" class="flex items-center gap-2 bg-surface hover:bg-surfaceHighlight text-textMain border border-border px-4 py-2 rounded-lg font-medium transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
            Nouveau travail
          </a>
        </div>

        {{if or (eq (len .Persons) 0) (eq (len .Bills) 0) }}
        <div class="p-12 rounded-2xl border-2 border-dashed border-border bg-surface/50 text-center">
          <div class="w-16 h-16 bg-surfaceHighlight rounded-full flex items-center justify-center mx-auto mb-4 text-textMuted">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
          </div>
          <h3 class="text-lg font-medium text-textMain mb-2">Aucune dépense</h3>
          <p class="text-textMuted max-w-md mx-auto">Ajoutez vos factures de travaux pour calculer automatiquement la quote-part de chaque copropriétaire.</p>
        </div>
        {{else}}
        <div class="overflow-hidden rounded-2xl border border-border shadow-sm bg-surface">
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
              <thead class="text-xs text-textMuted uppercase bg-surfaceHighlight border-b border-border">
                <tr>
                  <th class="px-6 py-4 font-semibold">Libellé</th>
                  {{range $person := .Persons}}
                  <th class="px-6 py-4 font-semibold text-textMain">{{$person.Name}}</th>
                  {{end}}
                  <th class="px-6 py-4 font-semibold text-primary">Total</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                {{range $bill := .Bills}}
                <tr class="hover:bg-surfaceHighlight/50 transition-colors">
                  <td class="px-6 py-4 font-medium text-textMain">{{$bill.Label}}</td>
                  {{range $person := $.Persons}}
                  <td class="px-6 py-4 text-textMuted">
                    {{printf "%.2f" ($person.CalculateDue $.TotalTantiemes $bill)}} €
                  </td>
                  {{end}}
                  <td class="px-6 py-4 font-bold text-primary">
                    {{$bill.Amount}} €
                  </td>
                </tr>
                {{end}}
                <tr class="bg-primary/5 font-bold text-textMain border-t-2 border-primary/20">
                  <td class="px-6 py-4">Solde restant</td>
                  {{range $person := .Persons}}
                  <td class="px-6 py-4 {{if lt ($person.CalculateLeft $.TotalTantiemes $.Bills $.Provisions) 0.0}}text-red-500{{else}}text-green-600{{end}}">
                    {{printf "%.2f" ($person.CalculateLeft $.TotalTantiemes $.Bills $.Provisions)}} €
                  </td>
                  {{end}}
                  <td class="px-6 py-4 text-primary">{{.Balance}} €</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        {{end}}
      </section>
    </main>

    <footer class="border-t border-border bg-surfaceHighlight/30 py-12 px-6 mt-16">
      <div class="max-w-7xl mx-auto grid grid-cols-2 md:grid-cols-4 gap-8">
        <div class="col-span-2 md:col-span-1">
           <div class="flex items-center gap-2 mb-4">
              <div class="w-6 h-6 rounded bg-primary flex items-center justify-center text-white text-xs font-bold">T</div>
              <span class="font-bold text-textMain">Tanzia</span>
           </div>
        </div>
        <div>
          <h4 class="font-semibold text-textMain mb-4">Produit</h4>
          <ul class="space-y-2 text-sm text-textMuted">
            <li><a href="/dashboard" class="hover:text-primary transition-colors">Tableau de bord</a></li>
            <li><a href="/tarifs" class="hover:text-primary transition-colors">Tarifs</a></li>
          </ul>
        </div>
        <div>
           <h4 class="font-semibold text-textMain mb-4">Ressources</h4>
           <ul class="space-y-2 text-sm text-textMuted">
             <li><a href="/cgv" class="hover:text-primary transition-colors">CGV</a></li>
             <li><a href="/legals" class="hover:text-primary transition-colors">Mentions légales</a></li>
           </ul>
        </div>
        <div class="text-right">
          <p class="text-textMuted text-sm">© 2025 Tanzia</p>
        </div>
      </div>
    </footer>

    <script>
      const themeToggleBtn = document.getElementById('theme-toggle');
      const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
      const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

      function updateIcons() {
        const isDark = document.documentElement.classList.contains('dark');
        if (isDark) {
          themeToggleDarkIcon.classList.add('hidden');
          themeToggleLightIcon.classList.remove('hidden');
        } else {
          themeToggleDarkIcon.classList.remove('hidden');
          themeToggleLightIcon.classList.add('hidden');
        }
      }

      function toggleTheme() {
        if (document.documentElement.classList.contains('dark')) {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('theme', 'light');
        } else {
            document.documentElement.classList.add('dark');
            localStorage.setItem('theme', 'dark');
        }
        updateIcons();
      }

      themeToggleBtn.addEventListener('click', toggleTheme);
      updateIcons();
    </script>

    <div id="upgrade-modal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeUpgradeModal()"></div>
      <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-6 bg-surface rounded-2xl border border-border shadow-2xl">
        <div class="text-center">
          <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
          </div>
          <h3 class="text-xl font-bold text-textMain mb-2">Limite atteinte</h3>
          <p id="upgrade-modal-message" class="text-textMuted mb-6">Vous avez atteint la limite de votre forfait gratuit.</p>
          <div class="flex flex-col gap-3">
            <form action="/subscribe" method="POST">
              <button type="submit" class="w-full flex items-center justify-center gap-2 bg-primary hover:bg-primaryHover text-white font-bold px-6 py-3 rounded-xl shadow-lg shadow-primary/20 transition-all hover:-translate-y-0.5">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                Passer au Premium - 9€/mois
              </button>
            </form>
            <button onclick="closeUpgradeModal()" class="w-full text-textMuted hover:text-textMain font-medium py-2 transition-colors">
              Annuler
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Free tier limit modal handling
      const limitMessages = {
        'limit-persons': 'Vous avez atteint la limite de 5 copropriétaires. Passez au Premium pour en ajouter plus.',
        'limit-bills': 'Vous avez atteint la limite de 5 travaux. Passez au Premium pour en ajouter plus.',
        'limit-provisions': 'Vous avez atteint la limite de 10 provisions. Passez au Premium pour en ajouter plus.'
      };

      function showUpgradeModal(limitType) {
        const modal = document.getElementById('upgrade-modal');
        const message = document.getElementById('upgrade-modal-message');
        message.textContent = limitMessages[limitType] || 'Vous avez atteint la limite de votre forfait gratuit.';
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      }

      function closeUpgradeModal() {
        const modal = document.getElementById('upgrade-modal');
        modal.classList.add('hidden');
        document.body.style.overflow = '';
        // Clear the hash without triggering a page reload
        history.replaceState(null, '', window.location.pathname);
      }

      // Check for limit hash on page load
      function checkLimitHash() {
        const hash = window.location.hash.substring(1);
        if (hash && limitMessages[hash]) {
          showUpgradeModal(hash);
        }
      }

      // Run on page load and hash change
      checkLimitHash();
      window.addEventListener('hashchange', checkLimitHash);

      // Close modal on Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeUpgradeModal();
        }
      });
    </script>
  </body>
</html>
